(function(a,b){a.tern=a.tern||{},a.tern.def={init:b}})(window,function(a,b){"use strict";function c(a,b){return Object.prototype.hasOwnProperty.call(a,b)}function d(a,b,c){return a.call?a(b,c):a}function e(a,c){if("!ret"==c){if(a.retval)return a.retval;var d=new b.AVal;return a.propagate(new b.IsCallee(b.ANull,[],null,d)),d}return a.getProp(c)}function f(a,c,e,f){return function(g,h){for(var j=[],k=0;k<c.length;k++)j.push(d(c[k],g,h));return new b.Fn(a,b.ANull,j,d(e,g,h),f)}}function g(a){return function(c,e){for(var f=new b.AVal,g=0;g<a.length;g++)d(a[g],c,e).propagate(f);return f.maxWeight=1e5,f}}function h(a){return function(c,d){return new b.Arr(a(c,d))}}function i(a){return function(c,e){return new b.Arr(a.map(function(a){return d(a,c,e)}))}}function j(a,c){return function(e,f){var g=new b.Obj;return a.forEach(function(a,b){g.defProp(a).addType(d(c[b],e,f))}),g}}function k(a){if(a instanceof b.Fn&&a.args)for(var c,d=0;d<a.args.length;++d)c=a.args[d],c instanceof b.Fn&&c.args&&c.args.length&&l(a,d)}function l(a,c){n(a,function(d,e){e[c]&&e[c].propagate(new b.IsCallee(b.cx().topScope,a.args[c].args,null,b.ANull))})}function m(a,c,d,e){var f=new w(a,null,d,e).parseType(!1,c,!0);return f instanceof b.AVal?f.types.forEach(k):k(f),f}function n(a,b,c){var d=a.computeRet,e=a.retval;a.computeRet=function(a,f,g){var h=b(a,f,g),i=d?d(a,f,g):e;return c?h:i}}function o(a,c){for(var d,e=0;e<c.length&&a!=b.ANull;++e)if(d=c[e],"!"==d.charAt(0)){if("!proto"==d)a=a instanceof b.Obj&&a.proto||b.ANull;else{var f=a.getFunctionType();if(!f)a=b.ANull;else if("!ret"==d)a=f.retval&&f.retval.getType(!1)||b.ANull;else{var g=f.args&&f.args[+d.slice(1)];a=g&&g.getType(!1)||b.ANull}}}else if(a instanceof b.Obj&&("prototype"==d&&a instanceof b.Fn||a.hasProp(d))){var h=a.getProp(d);a=!h||h.isEmpty()?b.ANull:h.types[0]}else a=b.ANull;return a}function p(a){var b=Object.create(a.prototype);return b.props=Object.create(null),b.isShell=!0,b}function q(a){if(!a["!type"]||/^(fn\(|\[|\+)/.test(a["!type"]))return!1;for(var b in a)if("!type"!=b&&"!doc"!=b&&"!url"!=b&&"!span"!=b&&"!data"!=b)return!1;return!0}function r(a,d,e){if(!a){var f=d["!type"];if(!f)a=d["!stdProto"]?b.cx().protos[d["!stdProto"]]:p(b.Obj);else if(/^fn\(/.test(f))a=p(b.Fn);else if("["==f.charAt(0))a=p(b.Arr);else if("+"==f.charAt(0))a=p(b.Obj);else throw new Error("Invalid !type spec: "+f);a.name=e}for(var g in d)if(c(d,g)&&33!=g.charCodeAt(0)){var h=d[g];if("string"==typeof h||q(h))continue;var i=a.defProp(g);r(i.getObjType(),h,e?e+"."+g:g).propagate(i)}return a}function s(a,d,e){if(a.isShell){delete a.isShell;var f=d["!type"];if(f)m(f,e,a);else{var g=d["!proto"]&&m(d["!proto"]);b.Obj.call(a,!(g instanceof b.Obj)||g,e)}}var h=d["!effects"];if(h&&a instanceof b.Fn)for(var j=0;j<h.length;++j)y(h[j],a);for(var i in t(d,a),d)if(c(d,i)&&33!=i.charCodeAt(0)){var k=d[i],l=a.defProp(i),n=e?e+"."+i:i;if("string"==typeof k)l.isEmpty()&&m(k,n).propagate(l);else{if(!q(k))s(l.getObjType(),k,n);else if(l.isEmpty())m(k["!type"],n,null,!0).propagate(l);else continue;k["!doc"]&&(l.doc=k["!doc"]),k["!url"]&&(l.url=k["!url"]),k["!span"]&&(l.span=k["!span"])}}return a}function t(a,b){a["!doc"]&&(b.doc=a["!doc"]),a["!url"]&&(b.url=a["!url"]),a["!span"]&&(b.span=a["!span"]),a["!data"]&&(b.metaData=a["!data"])}function u(a,c){var d=b.cx(),e=d.parent;b.addOrigin(d.curOrigin=a["!name"]||"env#"+d.origins.length),d.localDefs=d.definitions[d.curOrigin]=Object.create(null),e&&e.signal("preLoadDef",a),r(c,a);var f=a["!define"];if(f){for(var g in f){var h=f[g];d.localDefs[g]="string"==typeof h?z(h):r(null,h,g)}for(var g in f){var h=f[g];"string"!=typeof h&&s(d.localDefs[g],f[g],g)}}s(c,a),e&&e.signal("postLoadDef",a),d.curOrigin=d.localDefs=null}function v(){var a=b.cx().definitions.ecmascript;return a&&new b.Obj(a["Promise.prototype"])}var w=a.TypeParser=function(a,b,c,d){this.pos=b||0,this.spec=a,this.base=c,this.forceNew=d};w.prototype={eat:function(a){if(1==a.length?this.spec.charAt(this.pos)==a:this.spec.indexOf(a,this.pos)==this.pos)return this.pos+=a.length,!0},word:function(a){for(var b,c="",a=a||/[\w$]/;(b=this.spec.charAt(this.pos))&&a.test(b);)c+=b,++this.pos;return c},error:function(){throw new Error("Unrecognized type spec: "+this.spec+" (at "+this.pos+")")},parseFnType:function(a,c,d,e){var g=[],h=[],j=!1;if(!this.eat(")"))for(var k=0;;++k){var i,l=this.spec.indexOf(": ",this.pos);-1!=l&&(i=this.spec.slice(this.pos,l),/^(\.\.\.)?[$\w?]+$/.test(i)?this.pos=l+2:i=null),h.push(i);var m=this.parseType(a);if(m.call&&(j=!0),g.push(m),!this.eat(", ")){this.eat(")")||this.error();break}}var n,o,p,q;if(this.eat(" -> ")){var r=this.pos;n=this.parseType(!0),n.call&&!j&&(o=n,n=b.ANull,p=r)}else n=b.ANull;return j?f(c,g,n,e):(d&&(q=this.base)?b.Fn.call(this.base,c,b.ANull,g,h,n,e):q=new b.Fn(c,b.ANull,g,h,n,e),o&&(q.computeRet=o),null!=p&&(q.computeRetSource=this.spec.slice(p,this.pos)),q)},parseType:function(a,c,d){var e=this.parseTypeMaybeProp(a,c,d);if(!this.eat("|"))return e;for(var f,h=[e],j=e.call;;)if(f=this.parseTypeMaybeProp(a,c,d),h.push(f),f.call&&(j=!0),!this.eat("|"))break;if(j)return g(h);for(var k=new b.AVal,l=0;l<h.length;l++)h[l].propagate(k);return k.maxWeight=1e5,k},parseTypeMaybeProp:function(a,b,c){for(var d=this.parseTypeInner(a,b,c);a&&this.eat(".");)d=this.extendWithProp(d);return d},extendWithProp:function(a){var b=this.word(/[\w<>$!:]/)||this.error();return a.apply?function(c,d){return e(a(c,d),b)}:e(a,b)},parseTypeInner:function(a,c,d){var e;if(this.eat("fn(")||(e=this.eat("fn*(")))return this.parseFnType(a,c,d,e);if(this.eat("[")){for(var f,g=this.parseType(a),k=g.call;this.eat(", ");){f||(f=[g]);var l=this.parseType(a);f.push(l),k=k||l.call}return this.eat("]")||this.error(),k?f?i(f):h(g):d&&this.base?(b.Arr.call(this.base,f||g),this.base):new b.Arr(f||g)}if(this.eat("{")){var f=[],m=[],k=!1;if(!this.eat("}"))for(var n=0;;++n){var p,q=this.spec.indexOf(": ",this.pos);-1!=q&&(p=this.spec.slice(this.pos,q),/^[$\w?]+$/.test(p)?this.pos=q+2:p=null);var r=this.parseType(a);if(r.call&&(k=!0),m.push(p),f.push(r),!this.eat(", ")){this.eat("}")||this.error();break}}if(k)return j(m,f);var s=new b.Obj;return m.forEach(function(a,b){s.defProp(a).addType(f[b])}),s}if(this.eat("+")){var t=this.word(/[\w$<>\.:!]/),u=b.cx().localDefs[t+".prototype"];if(!u){var u=z(t);if(!(u instanceof b.Obj))return u;var v=o(u,["prototype"]);v&&(v=v.getObjType())&&(u=v)}if(a&&this.eat("["))return this.parsePoly(u);if(d&&this.base){this.base.proto=u;var c=u.hasCtor&&u.hasCtor.name||u.name;return c&&(this.base.name=c),this.base}return d&&this.forceNew?new b.Obj(u):b.getInstance(u)}if(this.eat(":")){var c=this.word(/[\w$\.]/);return b.getSymbol(c)}if(a&&this.eat("!")){var w=this.word(/\d/);if(w)return w=+w,function(a,c){return c[w]||b.ANull};if(this.eat("this"))return function(a){return a};if(this.eat("custom:")){var x=this.word(/[\w$]/);return A[x]||function(){return b.ANull}}return this.fromWord("!"+this.word(/[\w$<>\.!:]/))}return this.eat("?")?b.ANull:this.fromWord(this.word(/[\w$<>\.!:`]/))},fromWord:function(a){var c=b.cx();return"number"===a?c.num:"string"===a?c.str:"bool"===a?c.bool:"<top>"===a?c.topScope:c.localDefs&&a in c.localDefs?c.localDefs[a]:z(a)},parsePoly:function(a){var c,d="<i>";(c=this.spec.slice(this.pos).match(/^\s*([\w$:]+)\s*=\s*/))&&(d=c[1],this.pos+=c[0].length);var e=this.parseType(!0);if(this.eat("]")||this.error(),e.call)return function(c,f){var g=new b.Obj(a);return e(c,f).propagate(g.defProp(d)),g};var f=new b.Obj(a);return e.propagate(f.defProp(d)),f}};var x,y=a.parseEffect=function(a,c){var e;if(0==a.indexOf("propagate ")){var f=new w(a,10),g=f.parseType(!0);f.eat(" ")||f.error();var h=f.parseType(!0);n(c,function(a,b){d(g,a,b).propagate(d(h,a,b))})}else if(0==a.indexOf("call ")){var j=5==a.indexOf("and return ",5),f=new w(a,j?16:5),k=f.parseType(!0),l=null,m=[];for(f.eat(" this=")&&(l=f.parseType(!0));f.eat(" ");)m.push(f.parseType(!0));n(c,function(a,c){for(var e=d(k,a,c),f=l?d(l,a,c):b.ANull,g=[],h=0;h<m.length;++h)g.push(d(m[h],a,c));var i=j?new b.AVal:b.ANull;return e.propagate(new b.IsCallee(f,g,null,i)),i},j)}else if(e=a.match(/^custom (\S+)\s*(.*)/)){var i=A[e[1]];i&&n(c,e[2]?i(e[2]):i)}else if(0==a.indexOf("copy ")){var f=new w(a,5),o=f.parseType(!0);f.eat(" ");var p=f.parseType(!0);n(c,function(a,c){var e=d(o,a,c),f=d(p,a,c);e.forAllProps(function(a,c,d){d&&"<i>"!=a&&f.propagate(new b.DefProp(a,c))})})}else throw new Error("Unknown effect type: "+a)},z=a.parsePath=function(a,c){var d=b.cx(),e=d.paths[a],f=a;if(null!=e)return e;d.paths[a]=b.ANull;var g=c||x||d.topScope;if(d.localDefs)for(var h in d.localDefs)if(0==a.indexOf(h)){if(a==h)return d.paths[a]=d.localDefs[a];if("."==a.charAt(h.length)){g=d.localDefs[h],a=a.slice(h.length+1);break}}var i=o(g,a.split("."));return d.paths[f]=i==b.ANull?null:i,i};a.load=function(a,c){c||(c=b.cx().topScope);var d=x;x=c;try{u(a,c)}finally{x=d}},a.parse=function(a,c,d){var e=b.cx();c&&(e.origin=c,e.localDefs=e.definitions[c]);try{return"string"==typeof a?m(a,d):s(r(null,a,d),a,d)}finally{c&&(e.origin=e.localDefs=null)}};var A=Object.create(null);b.registerFunction=function(a,b){A[a]=b};var B=b.constraint({construct:function(a,b,c){this.created=a,this.target=b,this.spec=c},addType:function(a){if(a instanceof b.Obj&&5>this.created++){var c=new b.Obj(a),d=this.spec;if(d instanceof b.AVal&&(d=d.getObjType(!1)),d instanceof b.Obj)for(var e in d.props){var f=d.props[e].types[0],g=c.defProp(e);if(f&&f instanceof b.Obj&&f.props.value){var h=f.props.value.getType(!1);h&&g.addType(h)}}this.target.addType(c)}}});b.registerFunction("Object_create",function(a,c,d){if(d&&d.length&&"Literal"==d[0].type&&null==d[0].value)return new b.Obj;var e=new b.AVal;return c[0]&&c[0].propagate(new B(0,e,c[1])),e});var C=b.constraint({construct:function(a){this.target=a},addType:function(a){a instanceof b.Obj&&(a.hasProp("value")?a.getProp("value").propagate(this.target):a.hasProp("get")&&a.getProp("get").propagate(new b.IsCallee(b.ANull,[],null,this.target)))}});b.registerFunction("Object_defineProperty",function(a,c,d){if(d&&3<=d.length&&"Literal"==d[1].type&&"string"==typeof d[1].value){var e=c[0],f=new b.AVal;e.propagate(new b.DefProp(d[1].value,f,d[1])),c[2].propagate(new C(f))}return b.ANull}),b.registerFunction("Object_defineProperties",function(a,c,d){if(2<=c.length){var e=c[0];c[1].forAllProps(function(a,c,f){if(f){var g=new b.AVal;e.propagate(new b.DefProp(a,g,d&&d[1])),c.propagate(new C(g))}})}return b.ANull});var D=b.constraint({construct:function(a,b,c){this.self=a,this.args=b,this.target=c},addType:function(a){if(a instanceof b.Fn){this.target.addType(new b.Fn(a.name,b.ANull,a.args.slice(this.args.length),a.argNames.slice(this.args.length),a.retval,a.generator)),this.self.propagate(a.self);for(var c=0;c<Math.min(a.args.length,this.args.length);++c)this.args[c].propagate(a.args[c])}}});b.registerFunction("Function_bind",function(a,c){if(!c.length)return b.ANull;var d=new b.AVal;return a.propagate(new D(c[0],c.slice(1),d)),d}),b.registerFunction("Array_ctor",function(a,c){var d=new b.Arr;if(1!=c.length||!c[0].hasType(b.cx().num))for(var e=d.getProp("<i>"),f=0;f<c.length;++f)c[f].propagate(e);return d}),b.registerFunction("Promise_ctor",function(a,c,d){var e=v();if(!e||1>c.length)return b.ANull;var f=e.defProp(":t",d&&d[0]),g=new b.AVal;g.propagate(f);var h=new b.Fn("execute",b.ANull,[g],["value"],b.ANull),i=b.cx().definitions.ecmascript.Promise_reject;return c[0].propagate(new b.IsCallee(b.ANull,[h,i],null,b.ANull)),e}),b.registerFunction("Promise_resolve",function(a,c,d){var e=v();if(!e)return b.ANull;if(c.length){var f=e.defProp(":t",d&&d[0]),g=new b.AVal;g.propagate(f),c[0].propagate(new E(g))}return e});var E=b.constraint({construct:function(a){this.output=a},addType:function(a){a.constructor==b.Obj&&"Promise"==a.name&&a.hasProp(":t")?a.getProp(":t").propagate(this.output):a.propagate(this.output)}});return b.registerFunction("Promise_then",function(a,c,d){var e=c.length&&c[0].getFunctionType(),f=b.cx().definitions.ecmascript;if(!e||!f)return a;var g,h=new b.Obj(f["Promise.prototype"]),i=h.defProp(":t",d&&d[0]);return e.retval.isEmpty()&&(g=a.getType())instanceof b.Obj&&g.hasProp(":t")&&g.getProp(":t").propagate(i,50),e.retval.propagate(new E(i)),h}),b.registerFunction("getOwnPropertySymbols",function(a,c){if(!c.length)return b.ANull;var d=new b.AVal;return c[0].forAllProps(function(a,c,e){e&&":"==a.charAt(0)&&d.addType(b.getSymbol(a.slice(1)))}),d}),b.registerFunction("getSymbol",function(a,c,d){return d&&d.length&&"Literal"==d[0].type&&"string"==typeof d[0].value?b.getSymbol(d[0].value):b.ANull}),a});